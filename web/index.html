<!DOCTYPE html>
<html>
   <head>
      <title>Ebb and Flow - Hydroponics</title>

      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

      <!-- Latest compiled and minified CSS -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.js"></script>

      <!-- Optional theme -->
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

      <!-- Latest compiled and minified JavaScript -->

   </head>
   <body>
      <div class="container">
         <div class="row">
            <div class="col-md-12">
               <h1>Ebb and Flow</h1>
            </div>
         </div>
         <div class="row">
            <div class="col-md-4">
               <table class="table table-condensed table-bordered">
                  <thead>
                     <tr>
                        <th colspan="2">Sensores</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr id="env_temp_line">
                        <td>Temperatura Ambiente (&deg;C)</td>
                        <td><span id="env_temp">NA</span></td>
                     </tr>
                     <tr id="env_humidity_line">
                        <td>Umidade Ambiente (%)</td>
                        <td><span id="env_humidity">NA</span></td>
                     </tr>
                     <tr id="solution_temp_line">
                        <td>Temperatura Solu&ccedil;&atilde;o (&deg;C)</td>
                        <td><span id="solution_temp">NA</span></td>
                     </tr>
                     <tr id="solution_ph_line">
                        <td>pH Solu&ccedil;&atilde;o</td>
                        <td><span id="solution_ph">NA</span></td>
                     </tr>
                     <tr id="substrate_humidity_line">
                        <td>Umidade Substrato (%)</td>
                        <td><span id="substrate_humidity">NA</span></td>
                     </tr>
                  </tbody>
               </table>

               <table class="table table-condensed table-bordered">
                  <thead>
                     <tr>
                        <th colspan="2">Par&acirc;metros de Controle</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr id="substrate_humidity_set_point_line">
                        <td>SP Umidade Substrato (%)</td>
                        <td>
                           <input type="text" size="3" id="substrate_humidity_set_point" />
                           <button id="action_solution_humidity_set_point">OK</button>
                        </td>
                     </tr>
                     <tr id="solution_ph_set_point_line">
                        <td>SP pH</td>
                        <td>
                           <input type="text" size="3" id="solution_ph_set_point" />
                           <button id="action_solution_ph_set_point">OK</button>
                        </td>
                     </tr>
                  </tbody>
               </table>

               <table class="table table-condensed table-bordered">
                  <thead>
                     <tr>
                        <th colspan="2">Atuadores</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr id="substrate_humidity_pump_line">
                        <td>Bomba Solu&ccedil;&atilde;o</td>
                        <td><span id="substrate_humidity_pump">NA</span></td>
                     </tr>
                     <tr id="ph_up_pump_line">
                        <td>Bomba pH Up</td>
                        <td><span id="ph_up_pump">NA</span></td>
                     </tr>
                     <tr id="ph_down_pump_line">
                        <td>Bomba pH Down</td>
                        <td><span id="ph_down_pump">NA</span></td>
                     </tr>
                  </tbody>
               </table>
            </div>

            <div class="col-md-8">
               <div class="container-fluid">
                  <div class="row">
                     <div id="chart_table" style="height: 430px; width:100%;"></div>
                  </div>
                  <div class="row">
                     <input class="btn btn-default" type="button" id="action_solution_pump" value="Ligar Bomba Umidade Solu&ccedil;&atilde;o">
                     <input class="btn btn-default" type="button" id="action_ph_up_pump" value="Ligar Bomba pH Up">
                     <input class="btn btn-default" type="button" id="action_ph_down_pump" value="Ligar Bomba pH Down">
                     <input class="btn btn-default" type="button" id="action_ph_read" value="Efetuar leitura de pH">
                  </div>
            </div>
         </div>
      </div>

      <script>AUTOBAHN_DEBUG = true;</script>
      <script src="http://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
      <script src="canvasjs.min.js"></script>
      <script language="javascript">
         $(document).ready(function() {
            var system_status = {
               // Initial system status
               substrate_humidity_set_point: 0.0,
               solution_ph_set_point: 7.0,
               env_temp: '-',
               env_humidity: '-',
               solution_temp: '-',
               solution_ph: '-',
               solution_ph_data: [],
               substrate_humidity: '-',
               substrate_humidity_data: [],
               substrate_humidity_pump: '-',
               ph_up_pump: '-',
               ph_down_pump: '-'
            };

            var chart_table = new CanvasJS.Chart("chart_table", {
               zoomEnabled: true,
               axisX: {
                  gridThickness: 1,
                  valueFormatString: "HH:mm:ss",
               },
               axisY: {
                  title: "Umidade (%)",
                  gridThickness: 1,
                  stripLines: [{
                     value: system_status.substrate_humidity_set_point,
                     color:"#FF0000"
                  }],
                  minimum: 0,
                  maximum: 100
               },
               axisY2: {
                  title: "pH",
                  gridThickness: 1,
                  stripLines: [{
                     value: system_status.solution_ph_set_point,
                     color:"#00FF00"
                  }],
                  minimum: 0,
                  maximum: 14
               },
               legend: {
                  dockInsidePlotArea: true,
                  horizontalAlign: "right",
                  verticalAlign: "bottom",
                  fontSize: 12
               },
               data: [
                  {
                     showInLegend: true,
                     legendText: "Umidade do Substrato (%)",
                     type: "spline",
                     xValueType: "dateTime",
                     dataPoints: system_status.substrate_humidity_data
                  },
                  {
                     showInLegend: true,
                     legendText: "pH",
                     type: "spline",
                     axisYType: "secondary",
                     xValueType: "dateTime",
                     dataPoints: system_status.solution_ph_data,
                  }
               ]
            });

            var update_chart = function(chart, x_val, system_status) {
               var dataLength = 10 // number of dataPoints visible at any point
               system_status.substrate_humidity_data.push({
                  x: x_val,
                  y: system_status.substrate_humidity
               });
               if(system_status.substrate_humidity_data.length > dataLength) {
                  system_status.substrate_humidity_data.shift();
               }

               system_status.solution_ph_data.push({
                  x: x_val,
                  y: system_status.solution_ph
               });
               if(system_status.solution_ph_data.length > dataLength) {
                  system_status.solution_ph_data.shift();
               }

               chart.render();
            };

            var wsuri;
            if(document.location.origin === "file://") {
               wsuri = "ws://127.0.0.1:8080/ws";
            } else {
               wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" +
                        document.location.host + "/ws";
            }

            var connection = new autobahn.Connection({
               url: wsuri,
               realm: "realm1"
            });

            // fired when connection is established and session attached
            connection.onopen = function (session, details) {
               substrate_humidity_set_point = 0;

               // Button actions
               $("#action_solution_humidity_set_point").click(function() {
                  var substrate_humidity_set_point = $("#substrate_humidity_set_point").val();
                  system_status.substrate_humidity_set_point = parseFloat(substrate_humidity_set_point);
                  chart_table.options.axisY.stripLines[0].value = system_status.substrate_humidity_set_point;
                  chart_table.render();

                     // value: system_status['substrate_humidity_set_point']
               //    session.publish('com.ebbandflow.onwrite', [{
               //       'set_point': set_point
               //    }]);
               });
               $("#action_solution_ph_set_point").click(function() {
                  var solution_ph_set_point = $("#solution_ph_set_point").val();
                  system_status.solution_ph_set_point = parseFloat(solution_ph_set_point);
                  chart_table.options.axisY2.stripLines[0].value = system_status.solution_ph_set_point;
                  chart_table.render();
               });
               $('#action_solution_pump').click(function() {
                  alert('Mudar status bomba de agua da solução');
               });
               $('#action_ph_up_pump').click(function() {
                  alert('Mudar status bomba de pH up');
               });
               $('#action_ph_down_pump').click(function() {
                  alert('Mudar status bomba de ph down');
               });
               $('#action_ph_read').click(function() {
                  alert('Ler pH');
               });

               function on_read(args) {
                  // Executed when data is received from the plant
                  var data = args[0];
                  console.log("on_read() event received with data: " + data);
                  data_reading = JSON.parse(data)

                  // Actuators status
                  if('substrate_humidity_pump' in data_reading) {
                     $("#substrate_humidity_pump").html(data_reading.substrate_humidity_pump);
                     if(data_reading.substrate_humidity_pump === "ON") {
                        $("#substrate_humidity_pump_line").toggleClass("success", true);
                     }
                  }
                  if('ph_up_pump' in data_reading) {
                     $("#ph_up_pump").html(data_reading.ph_up_pump);
                     if(data_reading.ph_up_pump === "ON") {
                        $("#ph_up_pump_line").toggleClass("success", true);
                     }
                  }
                  if('ph_down_pump' in data_reading) {
                     $("#ph_down_pump").html(data_reading.ph_down_pump);
                     if(data_reading.ph_down_pump === "ON") {
                        $("#ph_down_pump_line").toggleClass("success", true);
                     }
                  }

                  // Sensor values
                  values_to_read = [
                     'env_temp', 'env_humidity', 'solution_temp',
                     'solution_ph', 'substrate_humidity'
                  ]
                  for(var i = 0; i < values_to_read.length; i++) {
                     value_key = values_to_read[i];
                     if(value_key in data_reading) {
                        system_status[value_key] = data_reading[value_key];
                        $('#' + value_key).html(data_reading[value_key]);
                     }
                  }

                  // Update chart
                  if('substrate_humidity' in data_reading) {
                     update_chart(chart_table, new Date(), system_status);
                  }
               }

               session.subscribe('com.ebbandflow.onread', on_read).then(
                  function (sub) {
                     console.log('subscribed to topic');
                  },
                  function (err) {
                     console.log('failed to subscribe to topic', err);
                  }
               );
            };

            // fired when connection was lost (or could not be established)
            connection.onclose = function (reason, details) {
               console.log("Connection lost: " + reason);
            }

            // now actually open the connection
            connection.open();
         });
      </script>

   </body>
</html>
